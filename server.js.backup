const express = require('express');
const { google } = require('googleapis');
const axios = require('axios');
const cheerio = require('cheerio');
const natural = require('natural');
const fs = require('fs');
const path = require('path');
const app = express();

const PORT = process.env.PORT || 3000;
app.use(express.json());

// ØªÙ†Ø¸ÛŒÙ…Ø§Øª Google Drive API
const SCOPES = ['https://www.googleapis.com/auth/drive.readonly'];
const GOOGLE_DRIVE_FOLDER_IDS = process.env.GOOGLE_DRIVE_FOLDER_IDS ? 
    process.env.GOOGLE_DRIVE_FOLDER_IDS.split(',') : [];

// Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´ Ø§ØµÙ„ÛŒ

// Ù…Ø­ØªÙˆØ§ÛŒ ØªØ³Øª Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ú©Ø§Ø±
knowledgeBase = [
    {
        category: "Ø¹Ù„ÙˆÙ… Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ",
        subcategory: "Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ†ÙˆÛŒØ³ÛŒ",
        content: "Node.js ÛŒÚ© Ù…Ø­ÛŒØ· Ø§Ø¬Ø±Ø§ÛŒÛŒ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ Ø³Ù…Øª Ø³Ø±ÙˆØ± Ø§Ø³Øª Ú©Ù‡ Ø¨Ø± Ù¾Ø§ÛŒÙ‡ Ù…ÙˆØªÙˆØ± V8 Ú©Ø±ÙˆÙ… Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.",
        source: "Ø³ÛŒØ³ØªÙ… ØªØ³Øª"
    },
    {
        category: "Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ", 
        subcategory: "Ø´Ø¹Ø± Ú©Ù„Ø§Ø³ÛŒÚ©",
        content: "Ø¨Ù†ÛŒ Ø¢Ø¯Ù… Ø§Ø¹Ø¶Ø§ÛŒ ÛŒÚ© Ù¾ÛŒÚ©Ø±Ù†Ø¯ Ú©Ù‡ Ø¯Ø± Ø¢ÙØ±ÛŒÙ†Ø´ Ø² ÛŒÚ© Ú¯ÙˆÙ‡Ø±Ù†Ø¯ Ú†Ùˆ Ø¹Ø¶ÙˆÛŒ Ø¨Ù‡ Ø¯Ø±Ø¯ Ø¢ÙˆØ±Ø¯ Ø±ÙˆØ²Ú¯Ø§Ø± Ø¯Ú¯Ø± Ø¹Ø¶ÙˆÙ‡Ø§ Ø±Ø§ Ù†Ù…Ø§Ù†Ø¯ Ù‚Ø±Ø§Ø±",
        source: "Ø³Ø¹Ø¯ÛŒ"
    },
    {
        category: "ÙÙ„Ø³ÙÙ‡ Ùˆ Ø¹Ø±ÙØ§Ù†",
        subcategory: "Ø¹Ø±ÙØ§Ù† Ø§Ø³Ù„Ø§Ù…ÛŒ",
        content: "Ø¹Ø§Ø±Ù Ú©Ø³ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø®Ø¯Ø§ Ø±Ø§ Ø§Ø² Ø±Ø§Ù‡ Ø´Ù‡ÙˆØ¯ Ùˆ Ú©Ø´Ù Ø¨Ø§Ø·Ù†ÛŒ Ù…ÛŒâ€ŒØ´Ù†Ø§Ø³Ø¯ Ù†Ù‡ ÙÙ‚Ø· Ø§Ø² Ø±Ø§Ù‡ Ø§Ø³ØªØ¯Ù„Ø§Ù„ Ùˆ Ø¨Ø±Ù‡Ø§Ù†.",
        source: "Ø³ÛŒØ³ØªÙ… ØªØ³Øª"
    },
    {
        category: "ØªØ§Ø±ÛŒØ® Ùˆ ØªÙ…Ø¯Ù†",
        subcategory: "Ø§ÛŒØ±Ø§Ù† Ø¨Ø§Ø³ØªØ§Ù†",
        content: "ØªÙ…Ø¯Ù† Ø§ÛŒØ±Ø§Ù† Ø¨Ø§Ø³ØªØ§Ù† ÛŒÚ©ÛŒ Ø§Ø² Ú©Ù‡Ù†â€ŒØªØ±ÛŒÙ† Ùˆ ØªØ§Ø«ÛŒØ±Ú¯Ø°Ø§Ø±ØªØ±ÛŒÙ† ØªÙ…Ø¯Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ù‡Ø§Ù† Ø§Ø³Øª Ú©Ù‡ Ù…ÛŒØ±Ø§Ø« ÙØ±Ù‡Ù†Ú¯ÛŒ ØºÙ†ÛŒ Ø§Ø² Ø®ÙˆØ¯ Ø¨Ù‡ Ø¬Ø§ÛŒ Ú¯Ø°Ø§Ø´ØªÙ‡ Ø§Ø³Øª.",
        source: "Ø³ÛŒØ³ØªÙ… ØªØ³Øª"
    },
    {
        category: "Ø¯ÛŒÙ† Ùˆ Ù…Ø°Ù‡Ø¨",
        subcategory: "Ø§Ø³Ù„Ø§Ù…",
        content: "Ø§Ø³Ù„Ø§Ù… Ø¯ÛŒÙ†ÛŒ ÛŒÚ©ØªØ§Ù¾Ø±Ø³ØªØ§Ù†Ù‡ Ø§Ø³Øª Ú©Ù‡ Ø¨Ø± Ù¾Ø§ÛŒÙ‡ Ù‚Ø±Ø¢Ù† Ùˆ Ø³Ù†Øª Ù¾ÛŒØ§Ù…Ø¨Ø± Ø§Ø³Ù„Ø§Ù… Ø¨Ù†Ø§ Ø´Ø¯Ù‡ Ø§Ø³Øª.",
        source: "Ø³ÛŒØ³ØªÙ… ØªØ³Øª"
    }
];
console.log('ğŸ“š Ù…Ø­ØªÙˆØ§ÛŒ ØªØ³Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯:', knowledgeBase.length, 'Ù…ÙˆØ±Ø¯');

 };

// ØªÙ†Ø¸ÛŒÙ… Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Google
function getAuth() {
    const auth = new google.auth.GoogleAuth({
        keyFile: process.env.GOOGLE_SERVICE_ACCOUNT_KEY || null,
        credentials: process.env.GOOGLE_CREDENTIALS ? JSON.parse(process.env.GOOGLE_CREDENTIALS) : null,
        scopes: SCOPES,
    });
    return auth;
}

// Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø§Ø² Google Drive
async function loadFromGoogleDrive() {
    try {
        const auth = getAuth();
        const drive = google.drive({ version: 'v3', auth });
        
        console.log('ğŸ“‚ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Google Drive...');
        
        for (const folderId of GOOGLE_DRIVE_FOLDER_IDS) {
            const response = await drive.files.list({
                q: `'${folderId}' in parents and mimeType contains 'text/'`,
                fields: 'files(id, name, mimeType, webViewLink)'
            });

            for (const file of response.data.files) {
                console.log(`ğŸ“– Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„: ${file.name}`);
                
                try {
                    const fileResponse = await drive.files.get({
                        fileId: file.id,
                        alt: 'media'
                    }, { responseType: 'stream' });

                    let content = '';
                    await new Promise((resolve, reject) => {
                        fileResponse.data
                            .on('data', chunk => content += chunk)
                            .on('end', resolve)
                            .on('error', reject);
                    });

                    await processContent(content, file.name);
                    
                } catch (error) {
                    console.error(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ ${file.name}:`, error.message);
                }
            }
        }
        
        console.log('âœ… Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Drive Ú©Ø§Ù…Ù„ Ø´Ø¯');
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Google Drive:', error.message);
    }
}

// Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø­ØªÙˆØ§ Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´
async function processContent(content, filename) {
    const lines = content.split('\n').filter(line => line.trim().length > 10);
    
    for (const line of lines) {
        const trimmedLine = line.trim();
        if (trimmedLine.length < 15) continue;

        // ØªØ´Ø®ÛŒØµ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ
        let category = 'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ';
        let subcategory = 'Ù…ØªÙØ±Ù‚Ù‡';

        if (trimmedLine.includes('Ø´Ø¹Ø±') || trimmedLine.includes('ØºØ²Ù„') || trimmedLine.includes('Ù‚ØµÛŒØ¯Ù‡')) {
            category = 'Ø§Ø¯Ø¨ÛŒØ§Øª ÙØ§Ø±Ø³ÛŒ';
            subcategory = trimmedLine.length < 100 ? 'Ø´Ø¹Ø± Ú©Ù„Ø§Ø³ÛŒÚ©' : 'Ø´Ø¹Ø± Ù…Ø¹Ø§ØµØ±';
        } else if (trimmedLine.includes('Ù‚Ø±Ø¢Ù†') || trimmedLine.includes('Ø­Ø¯ÛŒØ«') || trimmedLine.includes('Ø±ÙˆØ§ÛŒØª')) {
            category = 'Ø¯ÛŒÙ† Ùˆ Ù…Ø°Ù‡Ø¨';
            subcategory = 'Ù‚Ø±Ø¢Ù† Ùˆ ØªÙØ³ÛŒØ±';
        } else if (trimmedLine.includes('ÙÙ„Ø³ÙÙ‡') || trimmedLine.includes('Ø­Ú©Ù…Øª') || trimmedLine.includes('Ø¹Ø±ÙØ§Ù†')) {
            category = 'ÙÙ„Ø³ÙÙ‡ Ùˆ Ø¹Ø±ÙØ§Ù†';
            subcategory = 'ÙÙ„Ø³ÙÙ‡ Ø§Ø³Ù„Ø§Ù…ÛŒ';
        } else if (trimmedLine.includes('ØªØ§Ø±ÛŒØ®') || trimmedLine.includes('Ø³Ø§Ø³Ø§Ù†ÛŒ') || trimmedLine.includes('Ù‡Ø®Ø§Ù…Ù†Ø´ÛŒ')) {
            category = 'ØªØ§Ø±ÛŒØ® Ùˆ ØªÙ…Ø¯Ù†';
            subcategory = 'ØªØ§Ø±ÛŒØ® Ø§ÛŒØ±Ø§Ù†';
        } else if (trimmedLine.includes('Ø±ÛŒØ§Ø¶ÛŒ') || trimmedLine.includes('ÙÛŒØ²ÛŒÚ©') || trimmedCode.includes('Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…')) {
            category = 'Ø¹Ù„ÙˆÙ… Ùˆ ÙÙ†Ø§ÙˆØ±ÛŒ';
            subcategory = 'Ø±ÛŒØ§Ø¶ÛŒØ§Øª';
        }

        if (!knowledgeBase[category]) knowledgeBase[category] = {};
        if (!knowledgeBase[category][subcategory]) knowledgeBase[category][subcategory] = [];

        knowledgeBase[category][subcategory].push({
            content: trimmedLine,
            source: `Google Drive: ${filename}`,
            timestamp: new Date().toISOString()
        });
    }
}

// API Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
app.get('/api/search/:query', (req, res) => {
    const query = req.params.query.toLowerCase();
    const { category, limit = 50 } = req.query;
    
    const results = [];
    const tokenizer = new natural.WordTokenizer();
    
    Object.entries(knowledgeBase).forEach(([cat, subcategories]) => {
        if (category && category !== cat) return;
        
        Object.entries(subcategories).forEach(([subcat, items]) => {
            items.forEach(item => {
                const content = typeof item === 'string' ? item : item.content;
                const relevance = calculateRelevance(content, query, tokenizer);
                
                if (relevance > 0.1) { // Ø¢Ø³ØªØ§Ù†Ù‡ Ø§Ø±ØªØ¨Ø§Ø·
                    results.push({
                        category: cat,
                        subcategory: subcat,
                        content: content,
                        source: typeof item === 'object' ? item.source : 'Ø¯Ø§Ø®Ù„ÛŒ',
                        relevance: relevance,
                        preview: generatePreview(content, query)
                    });
                }
            });
        });
    });
    
    res.json({
        success: true,
        query,
        results: results
            .sort((a, b) => b.relevance - a.relevance)
            .slice(0, parseInt(limit)),
        total: results.length,
        categories: Object.keys(knowledgeBase)
    });
});

// Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø§ NLP
app.post('/api/advanced-search', (req, res) => {
    const { query, categories = [], minRelevance = 0.3 } = req.body;
    
    if (!query) {
        return res.status(400).json({ success: false, error: 'Ù¾Ø±Ø³â€ŒÙˆØ¬Ùˆ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª' });
    }

    const results = [];
    const tokenizer = new natural.WordTokenizer();
    const stemmer = natural.PorterStemmerFa;
    
    const queryStems = tokenizer.tokenize(query.toLowerCase()).map(token => stemmer.stem(token));
    
    Object.entries(knowledgeBase).forEach(([category, subcategories]) => {
        if (categories.length > 0 && !categories.includes(category)) return;
        
        Object.entries(subcategories).forEach(([subcategory, items]) => {
            items.forEach(item => {
                const content = typeof item === 'string' ? item : item.content;
                const relevance = calculateAdvancedRelevance(content, query, queryStems, tokenizer, stemmer);
                
                if (relevance >= minRelevance) {
                    results.push({
                        category,
                        subcategory,
                        content,
                        source: typeof item === 'object' ? item.source : 'Ø¯Ø§Ø®Ù„ÛŒ',
                        relevance,
                        highlighted: highlightText(content, query)
                    });
                }
            });
        });
    });
    
    res.json({
        success: true,
        query,
        results: results.sort((a, b) => b.relevance - a.relevance),
        total: results.length,
        metrics: {
            averageRelevance: results.length > 0 ? 
                results.reduce((sum, r) => sum + r.relevance, 0) / results.length : 0
        }
    });
});

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø±ØªØ¨Ø§Ø· Ù¾ÛŒØ´Ø±ÙØªÙ‡
function calculateAdvancedRelevance(text, query, queryStems, tokenizer, stemmer) {
    const textStems = tokenizer.tokenize(text.toLowerCase()).map(token => stemmer.stem(token));
    
    let exactMatches = 0;
    let stemMatches = 0;
    
    queryStems.forEach(stem => {
        if (textStems.includes(stem)) {
            stemMatches++;
        }
    });
    
    const words = query.toLowerCase().split(' ');
    words.forEach(word => {
        if (text.toLowerCase().includes(word)) {
            exactMatches++;
        }
    });
    
    const exactWeight = 0.7;
    const stemWeight = 0.3;
    
    return (exactMatches * exactWeight + stemMatches * stemWeight) / Math.max(words.length, 1);
}

// ØªÙˆÙ„ÛŒØ¯ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
function generatePreview(text, query, length = 150) {
    const index = text.toLowerCase().indexOf(query.toLowerCase());
    if (index === -1) {
        return text.substring(0, length) + (text.length > length ? '...' : '');
    }
    
    const start = Math.max(0, index - 50);
    const end = Math.min(text.length, index + query.length + 100);
    let preview = text.substring(start, end);
    
    if (start > 0) preview = '...' + preview;
    if (end < text.length) preview = preview + '...';
    
    return preview;
}

// Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ù…ØªÙ†
function highlightText(text, query) {
    const words = query.toLowerCase().split(' ').filter(w => w.length > 2);
    let highlighted = text;
    
    words.forEach(word => {
        const regex = new RegExp(`(${word})`, 'gi');
        highlighted = highlighted.replace(regex, '<mark>$1</mark>');
    });
    
    return highlighted;
}

// Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø§Ø±ØªØ¨Ø§Ø· Ø³Ø§Ø¯Ù‡
function calculateRelevance(text, query, tokenizer) {
    const textTokens = tokenizer.tokenize(text.toLowerCase());
    const queryTokens = tokenizer.tokenize(query.toLowerCase());
    
    if (queryTokens.length === 0) return 0;
    
    let matches = 0;
    queryTokens.forEach(qToken => {
        if (textTokens.some(tToken => tToken.includes(qToken) || qToken.includes(tToken))) {
            matches++;
        }
    });
    
    return matches / queryTokens.length;
}

// API Ø¯Ø±ÛŒØ§ÙØª Ø¢Ù…Ø§Ø±
app.get('/api/stats', (req, res) => {
    let totalItems = 0;
    let totalCategories = 0;
    let totalSubcategories = 0;
    
    Object.values(knowledgeBase).forEach(subcategories => {
        totalCategories++;
        Object.values(subcategories).forEach(items => {
            totalSubcategories++;
            totalItems += items.length;
        });
    });
    
    res.json({
        success: true,
        stats: {
            totalItems,
            totalCategories,
            totalSubcategories,
            lastUpdated: new Date().toISOString(),
            sources: ['Google Drive', 'Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø®Ù„ÛŒ']
        }
    });
});

// API Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ø¬Ø¯ÛŒØ¯
app.post('/api/content', (req, res) => {
    const { category, subcategory, content, source = 'Ú©Ø§Ø±Ø¨Ø±' } = req.body;
    
    if (!category || !subcategory || !content) {
        return res.status(400).json({ 
            success: false, 
            error: 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒØŒ Ø²ÛŒØ±Ø¯Ø³ØªÙ‡ Ùˆ Ù…Ø­ØªÙˆØ§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ù‡Ø³ØªÙ†Ø¯' 
        });
    }
    
    if (!knowledgeBase[category]) {
        knowledgeBase[category] = {};
    }
    if (!knowledgeBase[category][subcategory]) {
        knowledgeBase[category][subcategory] = [];
    }
    
    const newItem = {
        content: content.trim(),
        source: source,
        timestamp: new Date().toISOString(),
        addedBy: 'user'
    };
    
    knowledgeBase[category][subcategory].push(newItem);
    
    res.json({
        success: true,
        message: 'Ù…Ø­ØªÙˆØ§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯',
        item: newItem,
        totalInCategory: knowledgeBase[category][subcategory].length
    });
});

// API Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Google Drive
app.post('/api/sync/drive', async (req, res) => {
    try {
        await loadFromGoogleDrive();
        
        res.json({
            success: true,
            message: 'Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Google Drive Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯',
            timestamp: new Date().toISOString()
        });
    } catch (error) {
        res.status(500).json({
            success: false,
            error: 'Ø®Ø·Ø§ Ø¯Ø± Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ: ' + error.message
        });
    }
});

// Health check
app.get('/health', (req, res) => {
    res.json({
        status: 'healthy',
        service: 'Ù†Ø·Ù‚ Ù…ØµØ·Ù„Ø­ - Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´ Ù¾ÛŒØ´Ø±ÙØªÙ‡',
        version: '2.0.0',
        timestamp: new Date().toISOString(),
        knowledgeBase: {
            categories: Object.keys(knowledgeBase).length,
            totalItems: Object.values(knowledgeBase).reduce((total, subcats) => 
                total + Object.values(subcats).reduce((sum, items) => sum + items.length, 0), 0
            )
        }
    });
});

// Ø±ÙˆØª Ø§ØµÙ„ÛŒ - Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
app.get('/', (req, res) => {
    const html = `
    <!DOCTYPE html>
    <html lang="fa" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ù†Ø·Ù‚ Ù…ØµØ·Ù„Ø­ - Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´ Ø¹Ø¸ÛŒÙ… Ù…ØªØµÙ„ Ø¨Ù‡ Google Drive</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; }
            body { background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; min-height: 100vh; }
            .header { background: rgba(255,255,255,0.1); padding: 50px 20px; text-align: center; backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.2); }
            .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
            .dashboard { display: grid; grid-template-columns: 300px 1fr; gap: 30px; margin: 30px 0; }
            .sidebar { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 15px; height: fit-content; }
            .main-content { background: rgba(255,255,255,0.05); padding: 30px; border-radius: 15px; }
            .search-box { background: rgba(255,255,255,0.1); padding: 25px; border-radius: 12px; margin-bottom: 25px; }
            input, select, textarea, button { width: 100%; padding: 12px 15px; margin: 8px 0; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1em; }
            button { background: #3498db; border: none; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
            button:hover { background: #2980b9; transform: translateY(-2px); }
            button.success { background: #27ae60; }
            button.warning { background: #f39c12; }
            button.danger { background: #e74c3c; }
            .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin: 25px 0; }
            .stat-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; text-align: center; }
            .result-item { background: rgba(255,255,255,0.08); padding: 20px; border-radius: 10px; margin: 15px 0; border-right: 4px solid #3498db; transition: all 0.3s ease; }
            .result-item:hover { background: rgba(255,255,255,0.12); transform: translateX(-5px); }
            .category-badge { background: #e74c3c; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; margin-left: 8px; display: inline-block; }
            .source-badge { background: #9b59b6; padding: 3px 10px; border-radius: 12px; font-size: 0.75em; margin-right: 8px; }
            mark { background: #f1c40f; color: #2c3e50; padding: 2px 4px; border-radius: 3px; }
            .relevance-bar { height: 6px; background: rgba(255,255,255,0.2); border-radius: 3px; margin: 10px 0; overflow: hidden; }
            .relevance-fill { height: 100%; background: #2ecc71; border-radius: 3px; }
            .sync-status { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; margin: 15px 0; }
            .advanced-options { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin: 20px 0; }
            .tab-container { margin: 20px 0; }
            .tab-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
            .tab-button { flex: 1; text-align: center; padding: 12px; background: rgba(255,255,255,0.1); border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
            .tab-button.active { background: #3498db; }
            .tab-content { display: none; }
            .tab-content.active { display: block; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1 style="font-size: 2.8em; margin-bottom: 10px;">Ù†Ø·Ù‚ Ù…ØµØ·Ù„Ø­</h1>
            <p style="font-size: 1.3em; opacity: 0.9;">Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´ Ø¹Ø¸ÛŒÙ… Ù…ØªØµÙ„ Ø¨Ù‡ Google Drive - Ù…Ø³ØªÙ‚Ø± Ø±ÙˆÛŒ Vercel</p>
            <p style="opacity: 0.8; margin-top: 10px;">Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ÛŒ: ramin.edjlal1359@gmail.com | ramin.edjlal@gmail.com</p>
        </div>

        <div class="container">
            <div class="dashboard">
                <!-- Ø³Ø§ÛŒØ¯Ø¨Ø§Ø± -->
                <div class="sidebar">
                    <h3 style="margin-bottom: 20px; color: #3498db;">ğŸ“Š Ø¢Ù…Ø§Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡</h3>
                    <div id="statsContainer">
                        <!-- Ø¢Ù…Ø§Ø± ØªÙˆØ³Ø· JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                    </div>
                    
                    <div class="sync-status">
                        <h4 style="margin-bottom: 10px; color: #f39c12;">ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ</h4>
                        <button onclick="syncWithGoogleDrive()" class="warning">Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Google Drive</button>
                        <div id="syncStatus" style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;"></div>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <h4 style="margin-bottom: 15px; color: #2ecc71;">ğŸ“š Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</h4>
                        <div id="categoriesList">
                            <!-- Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§ ØªÙˆØ³Ø· JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                        </div>
                    </div>
                </div>

                <!-- Ù…Ø­ØªÙˆØ§ÛŒ Ø§ØµÙ„ÛŒ -->
                <div class="main-content">
                    <div class="tab-container">
                        <div class="tab-buttons">
                            <button class="tab-button active" onclick="switchTab('search')">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
                            <button class="tab-button" onclick="switchTab('add')">ğŸ“ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§</button>
                            <button class="tab-button" onclick="switchTab('advanced')">ğŸ¯ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</button>
                        </div>
                        
                        <!-- ØªØ¨ Ø¬Ø³ØªØ¬Ùˆ -->
                        <div id="tab-search" class="tab-content active">
                            <div class="search-box">
                                <h3 style="margin-bottom: 15px; color: #3498db;">Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´</h3>
                                <input type="text" id="searchInput" placeholder="Ø¹Ø¨Ø§Ø±ØªØŒ Ú©Ù„Ù…Ù‡ ÛŒØ§ Ù…ÙÙ‡ÙˆÙ… Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." 
                                       style="font-size: 1.1em; padding: 15px;">
                                <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-top: 10px;">
                                    <select id="categoryFilter">
                                        <option value="">Ù‡Ù…Ù‡ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§</option>
                                    </select>
                                    <button onclick="performSearch()" class="success" style="white-space: nowrap;">Ø¬Ø³ØªØ¬Ùˆ</button>
                                </div>
                            </div>
                            
                            <div id="searchResults">
                                <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§ -->
                        <div id="tab-add" class="tab-content">
                            <div class="search-box">
                                <h3 style="margin-bottom: 15px; color: #2ecc71;">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ø¬Ø¯ÛŒØ¯</h3>
                                <select id="addCategorySelect" required>
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
                                </select>
                                <input type="text" id="addSubcategory" placeholder="Ø²ÛŒØ±Ø¯Ø³ØªÙ‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                                <textarea id="addContent" placeholder="Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." rows="6" required></textarea>
                                <button onclick="addNewContent()" class="success">â• Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´</button>
                            </div>
                        </div>
                        
                        <!-- ØªØ¨ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
                        <div id="tab-advanced" class="tab-content">
                            <div class="search-box">
                                <h3 style="margin-bottom: 15px; color: #9b59b6;">Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</h3>
                                <textarea id="advancedQuery" placeholder="Ù¾Ø±Ø³Ø´ ÛŒØ§ Ù…ÙÙ‡ÙˆÙ… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ø§Ù…Ù„ Ø´Ø±Ø­ Ø¯Ù‡ÛŒØ¯..." rows="4"></textarea>
                                
                                <div class="advanced-options">
                                    <h4 style="margin-bottom: 10px;">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <div>
                                            <label>Ø­Ø¯Ø§Ù‚Ù„ Ø§Ø±ØªØ¨Ø§Ø· (%)</label>
                                            <input type="range" id="relevanceRange" min="10" max="100" value="30">
                                            <span id="relevanceValue">30%</span>
                                        </div>
                                        <div>
                                            <label>ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬</label>
                                            <select id="resultsLimit">
                                                <option value="10">Û±Û° Ù†ØªÛŒØ¬Ù‡</option>
                                                <option value="25" selected>Û²Ûµ Ù†ØªÛŒØ¬Ù‡</option>
                                                <option value="50">ÛµÛ° Ù†ØªÛŒØ¬Ù‡</option>
                                                <option value="100">Û±Û°Û° Ù†ØªÛŒØ¬Ù‡</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <button onclick="performAdvancedSearch()" class="warning">ğŸ¯ Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡</button>
                            </div>
                            
                            <div id="advancedResults">
                                <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
            async function initializeApp() {
                await loadStats();
                await loadCategories();
                await loadCategoryFilters();
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±
            async function loadStats() {
                try {
                    const response = await fetch('/api/stats');
                    const data = await response.json();
                    
                    if (data.success) {
                        document.getElementById('statsContainer').innerHTML = \`
                            <div class="stats-grid">
                                <div class="stat-card">
                                    <div style="font-size: 1.8em;">ğŸ“š</div>
                                    <h4>\${data.stats.totalItems.toLocaleString()}</h4>
                                    <small>Ù…ÙˆØ±Ø¯ Ù…Ø­ØªÙˆØ§</small>
                                </div>
                                <div class="stat-card">
                                    <div style="font-size: 1.8em;">ğŸ“‚</div>
                                    <h4>\${data.stats.totalCategories}</h4>
                                    <small>Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</small>
                                </div>
                                <div class="stat-card">
                                    <div style="font-size: 1.8em;">ğŸ”¤</div>
                                    <h4>\${data.stats.totalSubcategories}</h4>
                                    <small>Ø²ÛŒØ±Ø¯Ø³ØªÙ‡</small>
                                </div>
                            </div>
                            <div style="margin-top: 15px; opacity: 0.8; font-size: 0.9em;">
                                Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:<br>
                                \${new Date(data.stats.lastUpdated).toLocaleString('fa-IR')}
                            </div>
                        \`;
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø±:', error);
                }
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§
            async function loadCategories() {
                try {
                    const response = await fetch('/api/search/test');
                    const data = await response.json();
                    
                    if (data.categories) {
                        let categoriesHTML = '';
                        data.categories.forEach(category => {
                            categoriesHTML += \`<div style="margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px;">\${category}</div>\`;
                        });
                        document.getElementById('categoriesList').innerHTML = categoriesHTML;
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§:', error);
                }
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ
            async function loadCategoryFilters() {
                try {
                    const response = await fetch('/api/search/test');
                    const data = await response.json();
                    
                    if (data.categories) {
                        const categorySelect = document.getElementById('categoryFilter');
                        const addCategorySelect = document.getElementById('addCategorySelect');
                        
                        data.categories.forEach(category => {
                            const option1 = new Option(category, category);
                            const option2 = new Option(category, category);
                            categorySelect.add(option1);
                            addCategorySelect.add(option2);
                        });
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙÛŒÙ„ØªØ±Ù‡Ø§:', error);
                }
            }
            
            // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø§Ø¯Ù‡
            async function performSearch() {
                const query = document.getElementById('searchInput').value;
                const category = document.getElementById('categoryFilter').value;
                
                if (!query) {
                    alert('Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                let url = \`/api/search/\${encodeURIComponent(query)}\`;
                if (category) {
                    url += \`?category=\${encodeURIComponent(category)}\`;
                }
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    displaySearchResults(data);
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ:', error);
                    document.getElementById('searchResults').innerHTML = '<div style="text-align: center; color: #e74c3c;">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±</div>';
                }
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ
            function displaySearchResults(data) {
                const container = document.getElementById('searchResults');
                
                if (!data.success || data.results.length === 0) {
                    container.innerHTML = \`
                        <div style="text-align: center; padding: 40px; opacity: 0.7;">
                            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ”</div>
                            <h3>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                            <p>Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯</p>
                        </div>
                    \`;
                    return;
                }
                
                let resultsHTML = \`
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3>\${data.results.length} Ù†ØªÛŒØ¬Ù‡ Ø¨Ø±Ø§ÛŒ "\${data.query}"</h3>
                        <small style="opacity: 0.7;">\${data.total} Ù…ÙˆØ±Ø¯ Ø¯Ø± Ú©Ù„ Ù¾Ø§ÛŒÚ¯Ø§Ù‡</small>
                    </div>
                \`;
                
                data.results.forEach(result => {
                    const relevancePercent = Math.round(result.relevance * 100);
                    resultsHTML += \`
                        <div class="result-item">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <span class="category-badge">\${result.category}</span>
                                    <span class="category-badge" style="background: #3498db;">\${result.subcategory}</span>
                                    <span class="source-badge">\${result.source}</span>
                                </div>
                                <div style="font-size: 0.9em; opacity: 0.7; direction: ltr;">
                                    \${relevancePercent}%
                                </div>
                            </div>
                            <div class="relevance-bar">
                                <div class="relevance-fill" style="width: \${relevancePercent}%"></div>
                            </div>
                            <div style="font-size: 1.1em; line-height: 1.6; margin: 15px 0;">
                                \${result.preview || result.content}
                            </div>
                        </div>
                    \`;
                });
                
                container.innerHTML = resultsHTML;
            }
            
            // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            async function performAdvancedSearch() {
                const query = document.getElementById('advancedQuery').value;
                const minRelevance = parseInt(document.getElementById('relevanceRange').value) / 100;
                const limit = document.getElementById('resultsLimit').value;
                
                if (!query) {
                    alert('Ù„Ø·ÙØ§Ù‹ Ù¾Ø±Ø³Ø´ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                try {
                    const response = await fetch('/api/advanced-search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            query: query,
                            minRelevance: minRelevance,
                            limit: parseInt(limit)
                        })
                    });
                    
                    const data = await response.json();
                    displayAdvancedResults(data);
                } catch (error) {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡:', error);
                }
            }
            
            // Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            function displayAdvancedResults(data) {
                const container = document.getElementById('advancedResults');
                
                if (!data.success || data.results.length === 0) {
                    container.innerHTML = \`
                        <div style="text-align: center; padding: 40px; opacity: 0.7;">
                            <div style="font-size: 3em; margin-bottom: 15px;">ğŸ¯</div>
                            <h3>Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
                            <p>Ù¾Ø±Ø³Ø´ Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø­Ø¯Ø§Ù‚Ù„ Ø§Ø±ØªØ¨Ø§Ø· Ø±Ø§ Ú©Ø§Ù‡Ø´ Ø¯Ù‡ÛŒØ¯</p>
                        </div>
                    \`;
                    return;
                }
                
                let resultsHTML = \`
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3>\${data.results.length} Ù†ØªÛŒØ¬Ù‡ Ù¾ÛŒØ´Ø±ÙØªÙ‡</h3>
                        <small style="opacity: 0.7;">Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§Ø±ØªØ¨Ø§Ø·: \${Math.round(data.metrics.averageRelevance * 100)}%</small>
                    </div>
                \`;
                
                data.results.forEach(result => {
                    const relevancePercent = Math.round(result.relevance * 100);
                    resultsHTML += \`
                        <div class="result-item">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <span class="category-badge">\${result.category}</span>
                                    <span class="category-badge" style="background: #9b59b6;">\${result.subcategory}</span>
                                    <span class="source-badge">\${result.source}</span>
                                </div>
                                <div style="font-size: 0.9em; opacity: 0.7; direction: ltr;">
                                    \${relevancePercent}%
                                </div>
                            </div>
                            <div class="relevance-bar">
                                <div class="relevance-fill" style="width: \${relevancePercent}%"></div>
                            </div>
                            <div style="font-size: 1.1em; line-height: 1.6; margin: 15px 0;" dir="rtl">
                                \${result.highlighted || result.content}
                            </div>
                        </div>
                    \`;
                });
                
                container.innerHTML = resultsHTML;
            }
            
            // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§ÛŒ Ø¬Ø¯ÛŒØ¯
            async function addNewContent() {
                const category = document.getElementById('addCategorySelect').value;
                const subcategory = document.getElementById('addSubcategory').value || 'Ù…ØªÙØ±Ù‚Ù‡';
                const content = document.getElementById('addContent').value;
                
                if (!category || !content) {
                    alert('Ù„Ø·ÙØ§Ù‹ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ù…Ø­ØªÙˆØ§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                    return;
                }
                
                try {
                    const response = await fetch('/api/content', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            category: category,
                            subcategory: subcategory,
                            content: content,
                            source: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÛŒ'
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Ù…Ø­ØªÙˆØ§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÙØ²ÙˆØ¯Ù‡ Ø´Ø¯!');
                        document.getElementById('addContent').value = '';
                        document.getElementById('addSubcategory').value = '';
                        loadStats();
                    }
                } catch (error) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø­ØªÙˆØ§');
                    console.error(error);
                }
            }
            
            // Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Google Drive
            async function syncWithGoogleDrive() {
                const statusElement = document.getElementById('syncStatus');
                statusElement.innerHTML = 'ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ...';
                
                try {
                    const response = await fetch('/api/sync/drive', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        statusElement.innerHTML = \`âœ… \${data.message} - \${new Date().toLocaleTimeString('fa-IR')}\`;
                        loadStats();
                        loadCategories();
                    } else {
                        statusElement.innerHTML = \`âŒ \${data.error}\`;
                    }
                } catch (error) {
                    statusElement.innerHTML = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±';
                    console.error(error);
                }
            }
            
            // ØªØºÛŒÛŒØ± ØªØ¨
            function switchTab(tabName) {
                // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØªØ¨â€ŒÙ‡Ø§
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† ØªØ¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
                event.target.classList.add('active');
                document.getElementById('tab-' + tabName).classList.add('active');
            }
            
            // Ù…Ø¯ÛŒØ±ÛŒØª range
            document.getElementById('relevanceRange').addEventListener('input', function() {
                document.getElementById('relevanceValue').textContent = this.value + '%';
            });
            
            // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performSearch();
            });
            
            document.getElementById('advancedQuery').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') performAdvancedSearch();
            });
            
            // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
            document.addEventListener('DOMContentLoaded', initializeApp);
        </script>
    </body>
    </html>
    `;
    res.send(html);
});

// Ø´Ø±ÙˆØ¹ Ø³Ø±ÙˆØ± Ùˆ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² Google Drive
app.listen(PORT, async () => {
    console.log('ğŸš€ Ù†Ø·Ù‚ Ù…ØµØ·Ù„Ø­ - Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ù†Ø´ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯!');
    console.log('ğŸ“ Ø¢Ø¯Ø±Ø³: http://localhost:' + PORT);
    console.log('ğŸ“š Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Drive...');
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø² Google Drive (Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡)
    if (GOOGLE_DRIVE_FOLDER_IDS.length > 0 && process.env.GOOGLE_CREDENTIALS) {
        setTimeout(() => {
            loadFromGoogleDrive().catch(console.error);
        }, 2000);
    }
    
    console.log('ğŸ” Ø³ÛŒØ³ØªÙ… Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡: ÙØ¹Ø§Ù„');
    console.log('ğŸ”„ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Google Drive: ' + (GOOGLE_DRIVE_FOLDER_IDS.length > 0 ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„'));
});
